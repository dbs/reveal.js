<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>We aim to misbehave: Evergreen as a Progressive Web App</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">
<style>
.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
    text-transform: none;
}
.reveal img.inline-logo {
    border: none;
    vertical-align: middle;
    margin-right: 0.5em;
}
.reveal img.inline-logo.small {
    max-height: 2em;
    max-width: 2em;
}
.reveal .hidden {
    display:none;
}
.reveal .show {
    display:pre;
}
.reveal blockquote {
    text-align: left;
    width: 80%;
}
.reveal blockquote cite {
    font-size: 60%;
    float: right;
}
.reveal .demolinks {
    font-size: 80%;
}
li[onclick] {
    list-style-type: '† ';
}
</style>
<script>
function revealCode(showId, el, hideId) {
    let matches = document.querySelectorAll('.reveal .show');
    if (document.getElementById(showId).className == 'show') {
        document.getElementById(showId).className = 'hidden';
    }
    else {
        for (let match of matches) {
            match.className = 'hidden';
        }
        document.getElementById(showId).className = 'show';
    }
    if (el !== undefined && hideId !== undefined) {
        el.setAttribute('onclick', 'revealCode("' + hideId + '", this, "' + showId + '")');
    }
    Reveal.sync();
}
</script>
		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body vocab="https://schema.org/" typeof="PresentationDigitalDocument">
        <meta property="isAccessibleForFree" content="True" />
        <div class="reveal">
            <div class="slides">
                <section>
                    <section>
                        <span property="name">
                            <h1>We aim to misbehave</h1>
                            <h2>Evergreen: Progressive Web App</h2>
                        </span>
                        <p>
                            <span property="author" typeof="Person" resource="#author"><span property="givenName">Dan</span> <span property="familyName">Scott</span>,
                            <span property="worksFor" typeof="CollegeOrUniversity"><a href="https://laurentian.ca" property="url"><span
                                  property="name">Laurentian University</span></a></span>
                        </p>
                        <p property="publication" typeof="PublicationEvent"><span property="name">2017 Evergreen International Conference</span></p>
                        <p property="datePublished">2017-04-07</p>
                    </section>
                    <section>
                        <h2>Everyone wants an app</h2>
                        <ul>
                            <li>Offline access! Part of my device!</li>
                            <li class="fragment">But apps take time to develop:
                                <ul>
                                    <li>iOS vs. Android <span style="font-size: 60%">vs. Android <span style="font-size: 60%">vs. Android</span></span></li>
                                </ul>
                            </li>
                            <li class="fragment"><a href="https://www.recode.net/2016/9/16/12933780/average-app-downloads-per-month-comscore">Half of US users download 0 apps per month</a>
                                <ul>
                                    <li>Finding the right app can be hard</li>
                                    <li>App install banners can be annoying</li>
                                </ul>
                            </li>
                            <li class="fragment"><a href="http://info.localytics.com/blog/24-of-users-abandon-an-app-after-one-use">24% of people abandon an app after one use</a> (<em>Localytics</em>, 2017-03-30)</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Let's improve the web app we have</h3>
                        <blockquote>
                            Y'all got on this boat for different reasons, but y'all come to the same place.
                            So now I'm asking more of you than I have before. Maybe all. Sure as I know
                            anything, I know this - they will try again. […] They'll swing back to the
                            belief that they can make [native apps]… better. And I do not hold to that. So no
                            more runnin'. I aim to misbehave.
                                <cite><em>Serenity</em>, performance by Nathan Fillion, 2005-09-30.</cite>
                        </blockquote>
                    </section>
                </section>
				<section>
                    <section>
                        <h2>Progressive Web Apps are... what?</h2>
                    </section>
                    <section>
                        <h3>From graceful degradation to progressive enhancement</h3>
                        <aside class="notes">
                            Where graceful degradation was a web design
                            philosophy arguing that web sites should still be
                            functional in the absence of JavaScript or advanced
                            HTML, the progressive enhancement philosophy takes
                            JavaScript as a baseline and argues that you should
                            enable your site to take advantage of functionality
                            offered by different web browsers, particularly those
                            on a standards track.
                        </aside>
                    </section>
                    <section>
                        <h3>Progressive Web Apps (PWAs)</h3>
                        <ul>
                            <li><a href="https://developers.google.com/web/progressive-web-apps/checklist">Baseline</a> - make web apps more like native apps:
                                <ul>
                                    <li><em>Responsive</em>: UI adapts to different devices</li>
                                    <li><em>Fast</em> to load and render</li>
                                    <li><em>Secure</em>: encrypted by HTTPS</li>
                                    <li><em>Reliable</em> under any network condition</li>
                                    <li><em>Installable</em> to your device home screen</li>
                                </ul>
                            </li>
                        </ul>
                        <aside class="notes">
                            All of these are worthwhile goals.
                        </aside>
                    </section>
                    <section>
                        <h3>Progressive Web Apps (PWAs)</h3>
                        <ul>
                            <li>Usually built on frameworks like <a href="https://angular.io"><img
                                data-src="images/angular-logo.png" alt="Angular" class="inline-logo small" /></a>
                                or <a href="https://facebook.github.io/react/"><img data-src="images/react-logo.svg"
                                alt="React" class="inline-logo small"/></a></li>
                            <li>Common model: <em>app shell</em> built with templated HTML,
                                minified CSS and JavaScript, with REST calls to JSON data</li>
			    <li>Recent example: <a href=https://blog.twitter.com/2017/how-we-built-twitter-lite">Mobile Twitter</a> (2017-04-06)</li>
                            <li class="fragment">Almost like the JSPAC of yore…</li>
                            <li class="fragment"><a href="http://www.template-toolkit.org/"><img data-src="images/tt2-logo.png" alt="Template Toolkit" class="inline-logo small" /></a>Let's see what we can do with the TPAC</li>
                        </ul>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Auditing PWA progress</h3>
                            <ul>
                                <li><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> audits web apps for quality</li>
                                <li>Focused on PWA baseline criteria</li>
                                <li>Offers advice for <em>exemplary PWAs</em> as well</li>
                                <li>Chrome extension &amp; command line tool</li>
                            </ul>
                        </div>
                        <aside class="notes">
                            We would really benefit from an objective tool to
                            tell us how we're doing. Lighthouse is one such 
                            solution.
                        </aside>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Baseline: 37/100</h3>
                            <ul>
                                <li>Fresh Evergreen 2.12 install, without HTTPS</li>
                                <li>Praised for:
                                    <ul>
                                        <li>Page load performance is fast</li>
                                        <li>Site is progressively enhanced</li>
                                        <li>Design is mobile-friendly</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Baseline: 37/100</h3>
                            <ul>
                                <li>Fresh Evergreen 2.12 install, without HTTPS</li>
                                <li>Punished for:
                                    <ul>
                                        <li>Network connection is not encrypted</li>
					<li>User will not be prompted to <em>Add to Homescreen</em></li>
                                        <li>Installed web app will not launch with a splash screen</li>
                                        <li>Address bar will just be default colour</li>
                                        <li>App can't handle offline/flaky connections</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </section>
                    <section>
                        <h2>Let's encrypt that connection</h2>
                        <ul>
                            <li onclick="revealCode('tls-certbot')">Use <code>certbot</code> to get a free TLS certificate from <a href="https://letsencrypt.org">LetsEncrypt</a></li>
                            <li onclick="revealCode('tls-config')">Point the Apache config at the certificates</li>
                            <li onclick="revealCode('tls-everything')">Enable TLS for all connections</li>
                        </ul>
                        <pre id="tls-certbot" class="hidden"><code>certbot certonly --webroot -w /openils/var/web/ \
        -d shiny.example.org</code></pre>
                        <pre id="tls-config" class="hidden"><code>vim /etc/apache2/sites-enabled/eg.conf

SSLCertificateFile /etc/letsencrypt/live/shiny.example.org/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/shiny.example.org/privkey.pem</code></pre>
                        <pre id="tls-everything" class="hidden"><code>vim /etc/apache2/eg_vhost.conf

# Uncomment the following to force SSL for everything.
# Note that this defeats caching and you will suffer
# a performance hit.
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [NE,R,L]</code></pre>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Baseline with HTTPS: 50/100</h3>
                            <blockquote class="fragment">
                                <strong>Zoë:</strong> We mentioned that we were out of rations, and 10 minutes later, a bunch of apples rained into the trench.
                                <br /><strong>Wash:</strong> And they grew into a big tree, and they all climbed up the tree into a magical land with unicorns and a harp.
                                <cite>"War Stories." <em>Firefly</em>, performance by Gina Torres and Alan Tudyk, season 1, episode 9, 2002-12-06.</cite>
                            </blockquote>
                        </div>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Manifest destiny</h2>
                        <blockquote>
                            The purpose of the manifest is to install web
                            applications to the homescreen of a device,
                            providing users with quicker access and a richer
                            experience.
                            <cite>"Web App Manifest." <em><a
                                    href="https://developer.mozilla.org/en-US/docs/Web/Manifest">Mozilla
                                    Developer Network</a></em></cite>
                        </blockquote>
                    </section>
                    <section>
                        <h3>Manifest basics</h3>
                        <ul>
                            <li>A JSON file with metadata about the web app</li>
                            <li>A link to the manifest from the <code>&lt;head&gt;</code></li>
                        </ul>

                        <pre><code>{
  "short_name": "Shiny Cap'n",
  "name": "Shiny Cap'n",
  "description": "A real shiny public catalogue!",
  "start_url": "/eg/opac/home"
}</code></pre>
                        <pre><code>&lt;link rel="manifest" href="/manifest.json" /&gt;</code></pre>
                        <aside class="notes">
                            <ul>
                                <li><code>short_name</code> will be displayed on your device, underneath the icon</li>
                                <li><code>name</code> is displayed while the application loads</li>
                                <li><code>start_url</code> is where the application will open when you launch it</li>
                            </ul>
                        </aside>
                    </section>
                    <section>
                        <h3>Manifest icons</h3>
                        <p>Multiple icons for multiple screen densities</p>
                        <pre><code>{
  "short_name": "Shiny Cap'n",
  "icons": [{
      "src": "/images/icon48.png", "type": "image/png",
      "sizes": "48x48"
    },
    {
      "src": "/images/icon96.png", "type": "image/png",
      "sizes": "96x96"
    },
    {
      "src": "/images/icon192.png", "type": "image/png",
      "sizes": "192x192"
    }],
}</code></pre>
                        <aside class="notes">
                            192x192 is the most critical size
                        </aside>
                    </section>
                    <section>
                        <h3>Manifest theming</h3>
                        <p>While the app launches, give it nice colours</p>
                        <pre><code>{
  "short_name": "Shiny Cap'n",
  "background_color": "#007a54",
  "theme_color": "#007a54",
}</code></pre>
                        <aside class="notes">
                            <ul>
                                <li><code>background_color</code> is for the splash screen</li>
                                <li><code>theme_color</code> can affect the operating system (title bar, etc)</li>
                            </ul>
                        </aside>
                    </section>
                    <section>
                        <h3>Manifest <code>display</code></h3>
                        <ul>
                            <li>When the app launches, set <code>display</code> to either:
                                <ul>
                                    <li>Hide all user agent chrome: <em>fullscreen</em></li>
                                    <li>Launch as a separate application: <em>standalone</em></li>
                                </ul>
                            </li>
                            <li>Set <code>orientation</code> to either <em>portrait</em> or <em>landscape</em></li>
                        </ul>
                        <pre><code>{
  "short_name": "Shiny Cap'n",
  "display": "standalone",
  "orientation": "portrait"
}</code></pre>
                    </section>
                    <section>
                        <h3><code>link</code> and <code>meta</code> matching</h3>
                        <p><code>&lt;head&gt;</code> should contain
                        <code>&lt;link rel="icon" /&gt;</code> and
                        <code>&lt;meta rel="theme-color" /&gt;</code> elements
                        that match the manifest values:</p>
                        <pre><code data-trim>
                        &lt;meta rel="theme-color" value="#007a54" /&gt;
                        &lt;link rel="icon" sizes="192x192" href="images/icon192.png" /&gt;
                        </code></pre>
                    </section>

                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>HTTPS + manifest: 85/100</h3>
                            <blockquote class="fragment">
                                'Yes. Yes, this is a fertile land, and we will
                                thrive. We will rule over all this land, and we
                                will call it… "This Land."'
                                <cite>"Serenity." <em>Firefly</em>, performance by Alan Tudyk, season 1, episode 1, 2002-09-20. <em>Netflix</em>, https://www.netflix.com/watch/70133870?trackId=200257859.</cite>
                            </blockquote>
                        </div>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Optimizations</h2>
                        <ul>
                            <li><code>/eg/opac/home</code> first paint: 1648.1ms
                                <pre><code>…opac/home (shiny)
  …opac/semiauto.css (shiny) - 719.2ms, 14.61KB
  …opac/simple.js (shiny) - 796ms, 16.4KB
  …tundra/tundra.css (shiny) - 1,060.6ms, 54.93KB
  …css/style.css (shiny) - 1,175.7ms, 60.35KB
  …dojo/openils_dojo.js (shiny) - 1,456.5ms, 12.82KB
  …opensrf/JSON_v1.js (shiny) - 1,541.4ms, 15.97KB
  …opensrf/opensrf_xhr.js (shiny) - 1,571.1ms, 17.78KB
  …themes/dijit.css (shiny) - 1,640.9ms, 36.78KB
  …images/small_logo.png (shiny) - 1,747.4ms, 15.37KB
  …opensrf/opensrf.js (shiny) - 1,840.6ms, 39.31KB
  …images/eg_tiny_logo.png (shiny) - 1,926.7ms, 14.96KB
  …images/main_logo.png (shiny) - 1,941.4ms, 21.25KB
  …dojo/dojo.js (shiny) - 2,106ms, 92.59KB</code></pre>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>Dojo?!? Didn't we try to avoid Dojo?</h3>
                        <blockquote>
                            <strong>Kaylee</strong>: Everything's shiny, Cap'n. Not to fret.
                            <br /><strong>Mal</strong>: You told me those entry couplings would hold for another week!
                            <br /><strong>Kaylee</strong>: That was six months ago, Cap'n.
                            <cite><em>Serenity</em>, performances by Jewel Staite and Nathan Fillion, 2005-09-30.</cite>
                        </blockquote>
                    </section>
                    <section>
                        <h3><code>opac/parts/header.tt2</code></h3>
                        <pre><code># Dojo is required to use the copy locations advanced search
# filter, therefore, it should always be enabled.
want_dojo = 1;

IF use_autosuggest.enabled == "t";
    want_dojo = 1;
END;

IF ctx.google_books_preview;
    want_dojo = 1;
END;

IF ENV.OILS_NOVELIST_URL;
    want_dojo = 1;
END;
</code></pre>
                    </section>
                    <section>
                        <h3>The fix is in <a href="https://bugs.launchpad.net/evergreen/+bug/1411699">bug 1411699</a></h3>
                        <pre><code>…opac/home (shiny)
  …opac/semiauto.css (shiny) - 592ms, 11.48KB
  …opac/simple.js (shiny) - 642.3ms, 13.26KB
  …css/style.css (shiny) - 862.8ms, 58.53KB
  …images/eg_tiny_logo.png (shiny) - 1,041.5ms, 11.82KB
  …images/main_logo.png (shiny) - 1,071.5ms, 18.12KB</code></pre>
                        <ul>
                            <li class="fragment">Still 85/100 , but first paint is down to 1011.9ms!</li>
                            <li class="fragment">Most of the points are docked because we fail the <em>App can load on offline/flaky connections</em> test</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Are we the Serenity?</h3>
                        <p>Kept in the air by love (and Kaylee)</p>
                    </section>
                    <section>
                        <h3>Or are we a Reaver Ship?</h3>
                        <p>Belching smoke and uncontained radiation...</p>
                        <p class="fragment">and Dojo 1.3</p>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Handling offline/flaky connections:</h2>
                        <h3>Introducing service workers</h3>
                    </section>
                    <section>
                        <h3>Service workers</h3>
                        <ul>
                            <li>A separate JavaScript per origin <em>scope</em></li>
                            <li>Runs on a separate thread</li>
                            <li>No access to the DOM</li>
                            <li>Can intercept and modify network requests for fine-grained <a href="https://serviceworke.rs/">caching strategies</a></li>
                            <li>Enables push notifications, too!</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Service worker support</h3>
                        <ul>
                            <li><a href="https://jakearchibald.github.io/isserviceworkerready/">Supported by</a> Chrome, Firefox, Opera today</li>
                            <li class="fragment">Microsoft Edge is working on it</li>
                            <li class="fragment">Safari… 🤷</li>
                            <li class="fragment">But progressive enhancement means it's okay!</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Service worker registration</h3>
                        <pre><code>&lt;script&gt;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // Your service worker *must* be located at
    // the top-level directory relative to your site.
    // It won't be able to control pages unless it's
    // located at the same level or higher than them.
    navigator.serviceWorker.register('/sw.js')
      .then(function(reg) { /* … stuff! */ })
      .catch(function(e) { console.error('Error:', e); });
  }
}
&lt;/script&gt;</code></pre>
                        <cite>Adapted from <a href="https://github.com/GoogleChrome/sw-precache/blob/master/demo/app/js/service-worker-registration.js">Google SW registration boilerplate</a></cite>
                    </section>
                    <section>
                        <h3>Service worker: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a></h3>
                        <ul>
                            <li>More flexible than <code>XMLHttpRequest()</code>
                                <ul>
                                    <li>Generic <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request">Request</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">Response</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Headers">Headers</a> interfaces</li>
                                </ul>
                            </li>
                            <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent">FetchEvent</a> handler + <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">fetch()</a> + <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">Cache API</a> + cache dedicated to a given web app:
                                <ul>
                                    <li>Fetch network requests from the cache</li>
                                    <li>Store network responses in the cache</li>
                                    <li class="fragment">Overcome network flakiness!</li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>Let there be patterns!</h3>
                        <p><a href="https://serviceworke.rs/">serviceworke.rs</a> offers examples of caching strategies</p>
                    </section>
                    <section>
                        <h3><a href="https://serviceworke.rs/strategy-network-or-cache.html">Network-or-cache</a></h3>
                        <pre><code>self.addEventListener('fetch', function(evt) {
  if evt.respondWith(fromNetwork(evt.request, 400)
  .catch(function () {
    return fromCache(evt.request);
  }));
});
function fromNetwork(request, timeout) {
  return new Promise(function (fulfill, reject) {
  var timeoutId = setTimeout(reject, timeout);
  fetch(request).then(function (response) {
      clearTimeout(timeoutId);
      fulfill(response);
    }, reject);
  });
}</code></pre>
                    </section>
                    <section>
                        <h3><a href="https://serviceworke.rs/strategy-cache-and-update.html">Cache and update</a></h3>
                        <pre><code>self.addEventListener('fetch', function(evt) {
  evt.respondWith(fromCache(evt.request));
  evt.waitUntil(update(evt.request));
});
function fromCache(request) {
  return caches.open(CACHE).then(function (cache) {
    return cache.match(request).then(function (matching) {
      return matching || Promise.reject('no-match');
    });
  });
}
function update(request) {
  return caches.open(CACHE).then(function (cache) {
    return fetch(request).then(function (response) {
      return cache.put(request, response);
    });
  });
}</code></pre>
                    </section>
                    <section>
                        <h3>Let there be tools!</h3>
                        <ul>
                            <li>We could roll our own service worker based on the <a href="https://serviceworke.rs/">serviceworke.rs</a> patterns</li>
                            <li>But libraries provide a nice layer of abstraction:
                                <ul>
                                    <li><a href="https://github.com/GoogleChrome/sw-toolbox">sw-toolbox</a> implements network handlers with five request/caching patterns</li>
                                    <li><a href="https://github.com/GoogleChrome/sw-precache">sw-precache</a> builds on <code>sw-toolbox</code> to generate a service worker based on a configuration file</li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>package.json</h3>
<pre><code>{
  "name": "evergreen-pwa-stuff",
  "version": "1.0.0",
  "description": "Evergreen PWA stuff",
  "author": "Dan Scott",
  "license": "GPL-2.0+",
  "dependencies": {
    "sw-precache": "&gt;4.3.0"
  }
}</code></pre>
<pre><code>$ npm install</code></pre>
                    </section>
                    <section>
                        <h3>sw-precache basic dumb config</h3>
                        <pre><code>module.exports = {
  staticFileGlobs: [
    '/openils/var/web/css/skin/default/opac/semiauto.css',
    '/openils/var/web/js/ui/default/opac/simple.js',
    '/openils/var/web/opac/images/small_logo.png',
    '/openils/var/web/opac/images/progressbar_green.png',
    '/openils/var/web/opac/images/main_logo.png',
    '/openils/var/web/opac/images/eg_tiny_logo.png'
  ],
  stripPrefix: '/openils/var/web/',
  runtimeCaching: [{
    urlPattern: /^https:\/\/shiny.example.org\//,
    handler: 'networkFirst'
  }]
};</code></pre>
                    </section>
                    <section>
                        <h3>Enable our service worker</h3>
                        <ol>
                            <li onclick="revealCode('sw-generate')">Generate and install the service worker</li>
                            <li onclick="revealCode('sw-copy')">Install the boilerplate registration code</li>
                            <li onclick="revealCode('sw-register')">Add registration code to <code style="font-size: smaller;white-space:nowrap;">templates/opac/parts/base.tt2</code></li>
                        </ol>
                        <pre id="sw-generate" class="hidden"><code data-noescape data-trim class="lang-none">
$ <strong>node_modules/sw-precache/cli.js --config sw-precache.js</strong>
Total precache size is about 18.2 kB for 6 resources.
service-worker.js has been generated.
$ <strong>cp service-worker.js /openils/var/web/sw.js</strong>
                        </code></pre>
                        <pre id="sw-copy" class="hidden"><code data-noescape data-trim class="lang-none">
$ <strong>cp sw-register.js /openils/var/web/.</strong>
                        </code></pre>
                        <pre id="sw-register" class="hidden"><code data-trim>
<script src="/js/sw-register.js" async ></script>
                        </code></pre>
                        <aside class="notes">
                            <p>
                            <code>async</code> tells the browser to load the
                            script asynchronously so that it does not delay
                            rendering.
                            </p>
                            <p>
                            However, this still results in horrible FOUCs on Firefox,
                            so instead we just include the code at the bottom of
                            base.tt2.
                            </p>
                        </aside>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>HTTPS + manifest + service worker: 100/100</h3>
                            <p class="fragment">Shut. Up.</p>
                        </div>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>100/100 PWA score!<sup>*</sup></h2>
                        <ul>
                            <li class="fragment" data-fragment-index="2">Specifically, no <em>My Account</em> pages are available offline</li>
                            <li class="fragment" data-fragment-index="3">That was kind of the point of the exercise</li>
                        </ul>
                        <p class="fragment" data-fragment-index="1"><sup>*</sup>Score may not reflect real-world experiences</p>
                    </section>
                    <section>
                        <h2>"My Account" headers</h2>
                        <pre><code data-trim class="lang-none">
cache-control: no-store, no-cache, must-revalidate
expires: -1
                        </code></pre>
                        <ul>
                            <li><code>no-store</code> means "never cache this"</li>
                            <li><code>expires: -1</code> means "this expires immediately"</li>
                            <li class="fragment fade-right">No network connection? You shall not see your checked out items!</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Radical surgery</h3>
                        <pre><code data-trim class="lang-diff">
diff --git a/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGCatLoader.pm b/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGCatLoader.pm
index 6aa1f58..6548edc 100644
--- a/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGCatLoader.pm
+++ b/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGCatLoader.pm
@@ -184,8 +184,7 @@ sub load {
 return $self-&gt;redirect_auth unless $self-&gt;editor-&gt;requestor;
 
 # Don't cache anything requiring auth for security reasons
-$self-&gt;apache-&gt;headers_out-&gt;add("cache-control" =&gt; "no-store, no-cache, must-revalidate");
-$self-&gt;apache-&gt;headers_out-&gt;add("expires" =&gt; "-1");
+$self-&gt;apache-&gt;headers_out-&gt;add("cache-control" =&gt; "no-cache, must-revalidate");
 
 return $self-&gt;load_email_record if $path =~ m|opac/record/email|;
                        </code></pre>
                    </section>
                    <section>
                        <h3>Rapid decay</h3>
                        <p>If we remove those headers, Expires becomes + 5 seconds due to <code>/etc/apache2/eg_vhost.conf</code>:</p>
                        <pre><code data-trim>
&lt;Location /eg/opac&gt;
  PerlSetVar OILSWebContextLoader "OpenILS::WWW::EGCatLoader"
  # Expire the HTML quickly since we're loading dynamic data
  ExpiresActive On
  ExpiresByType text/html "access plus 5 seconds"
&lt;/Location&gt;
                        </code></pre>
                        <p>It's dynamic, but there are alternatives to <code>Expires</code></p>
                    </section>
                    <section>
                        <h3>Enter ETag</h3>
                        <pre><code data-trim class="lang-diff">
diff --git a/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGWeb.pm b/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGWeb.pm
index da18d7e..21d4715 100644
--- a/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGWeb.pm
+++ b/Open-ILS/src/perlmods/lib/OpenILS/WWW/EGWeb.pm
@@ -129,11 +129,16 @@ sub handler_guts {
 $vhost_processor_cache{$processor_key} = $tt;
 $ctx-&gt;{encode_utf8} = sub {return encode_utf8(shift())};
 
-unless($tt-&gt;process($template, {ctx =&gt; $ctx, ENV =&gt; \%ENV, l =&gt; $text_handler}, $r)) {
+my $_out = '';
+unless($tt-&gt;process($template, {ctx =&gt; $ctx, ENV =&gt; \%ENV, l =&gt; $text_handler}, \$_out)) {
     $r-&gt;log-&gt;warn('egweb: template error: ' . $tt-&gt;error);
     return Apache2::Const::HTTP_INTERNAL_SERVER_ERROR;
 }
 
+my $etag = md5_hex(Encode::encode_utf8($_out);)
+$r-&gt;headers_out-&gt;add('Etag' =&gt; $etag);
+$r-&gt;print($_out);
+
 return Apache2::Const::OK;
                        </code></pre>
                        <aside class="notes">
                            <code>ETag</code> and <code>Last-Modified</code> enable the browser to check for updates
                        </aside>
                    </section>
                    <section>
                        <h3>Whither <code>Expires</code>?</h3>
                        <ul>
                            <li>Given <code>ETag</code> and <code>no-cache</code>, the browser will always make a request to the server</li>
                            <li>If the server can't respond (is down, or has no network connection), the service worker can</li>
                            <li>Bonus: for other HTML pages, <code>Expires</code> can be turned off</li>
                        </ul>
                        <pre><code data-trim>
&lt;Location /eg/opac&gt;
  PerlSetVar OILSWebContextLoader "OpenILS::WWW::EGCatLoader"
  ExpiresActive Off
&lt;/Location&gt;
                        </code></pre>

                    </section>
                </section>
                <section>
                    <section>
                        <h2>Add to Home Screen: Shiny!</h2>
                    </section>
                    <section>
                        <img data-src="images/pwa_add_to_home.jpg" alt="Add to Home Screen prompt" style="height:500px" />
                    </section>
                    <section>
                        <img data-src="images/pwa_added_notification.jpg" alt="Android notification that the PWA has been added to the home screen" style="height:500px" />
                    </section>
                    <section>
                        <img data-src="images/pwa_app_drawer.png" alt="Android app drawer with PWA" style="height:500px" />
                    </section>
                    <section>
                        <img data-src="images/pwa_launcher_1.jpg" alt="Android PWA launcher splash screen" style="height:500px" />
                    </section>
                    <section>
                        <img data-src="images/pwa_launcher_2.jpg" alt="Android PWA launcher splash screen transition" style="height:500px" />
                    </section>
                    <section>
                        <img data-src="images/pwa_fullscreen.jpg" alt="Android PWA in full screen mode" style="height:500px" />
                    </section>
                </section>
                <section>
                    <section>
                        <h2>HTTP/2</h2>
                        <ul>
                            <li>Lighthouse recommends using HTTP/2</li>
                            <li>One TCP connection multiplexes requests and compresses headers</li>
                            <li>More efficient than four to eight separate connections per origin (<a href="https://http2.github.io/faq/#why-just-one-tcp-connection">http2 FAQ</a>)</li>
                            <li>Nginx--which we're already using to proxy websockets--supports HTTP/2</li>
                            <li>Let's get this thing going</li>
                        </ul>
                    </section>
                    <section>
                        <h3>HTTP/2 on Debian Jessie</h3>
                        <p>Jessie doesn't deliver a new enough version, so:</p>
                        <pre><code data-trim class="lang-none">
apt-get -t jessie-backports install nginx
                        </code></pre>
                    </section>
                    <section>
                        <h3>HTTP/2: nginx config</h3>
                        <pre><code data-trim class="lang-diff">
diff --git a/examples/nginx/osrf-ws-http-proxy b/examples/nginx/osrf-ws-http-proxy
index d079230..2fbf832 100644
--- a/examples/nginx/osrf-ws-http-proxy
+++ b/examples/nginx/osrf-ws-http-proxy
@@ -19,7 +19,7 @@ server {
 }
 
 server {
-    listen 443;
+    listen 443 ssl http2;
     ssl on;
 
     # Use the same SSL certificate as Apache.
                        </code></pre>
                    </section>
                    <section>
                        <h3>HTTP/2: Are we good?</h3>
                        <pre><code data-trim class="lang-none">
$ curl --http2 -H "Accept-Encoding: gzip" \
       -I https://shiny.example.org/eg/opac/home
HTTP/2 200 
server: nginx/1.10.3
date: Sat, 01 Apr 2017 15:44:15 GMT
content-type: text/html; encoding=utf8
etag: 1735fc80e7ea268e656d53ac9126e438
                        </code></pre>
                        <p class="fragment">nginx falls back to HTTP 1.1 for browsers that don't support HTTP/2</p>
                        <p class="fragment">(Yes, I tested with <strong>w3m</strong>)</p>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Brain dead approach PWA results</h2>
                        <p>Not bad. Almost ready for prime time!</p>
                        <p class="fragment">We've inadvertently enabled the web staff client--yay!?</p>
                        <p class="fragment">But we're lacking a few things…</p>
                    </section>
                    <section>
                        <h3>An offline fallback page</h3>
                        <ul>
                            <li>A search-driven app <em>will</em> lead to cache misses</li>
                            <li>Ideally, tell the user what they <em>can</em> access (perhaps via <a href="https://developer.mozilla.org/en-US/docs/Web/API/History_API">History API</a>?)</li>
                            <li>This will require custom service worker code</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Better control over GET params</h3>
                        <ul>
                            <li>Default behaviour is to treat the following pages as completely different:
                                <ul>
                                    <li><code data-noescape>https://shiny.example.org/eg/opac/myopac/holds?query=<span style="color:blue;background:yellow">potter</span></code></li>
                                    <li><code>https://shiny.example.org/eg/opac/myopac/holds?query=<span style="color:blue;background:yellow">harry</span></code></li>
                                </ul>
                            </li>
                            <li>For the <code>/myopac/</code> pages, at least, GET params shouldn't matter</li>
                            <li>This will require custom service worker code</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Separate the apps</h3>
                        <ul>
                            <li><code>/eg/opac/</code>, <code>/eg/staff/</code>, and <code>/eg/myopac/</code> are conceptually separate apps</li>
                            <li class="fragment">But common JS, image, CSS assets under <code>/</code> require them all to use the same service worker</li>
                            <li class="fragment">Instead, use <code>/eg/opac/assets/</code>, <code>/eg/staff/assets/</code>, and <code>/eg/myopac/assets</code> to serve up static assets from <code>/openils/var/web/</code>?</li>
                        </ul>
                    </section>
                    <section>
                        <h3>A modern <code>/eg/myopac</code>?</h3>
                        <ul>
                            <li>Precache a static app shell</li>
                            <li>Load fines, holds, lists, messages, etc as JSON over REST</li>
                            <li>Deliver native device notifications with the <a href="https://developer.mozilla.org/en/docs/Web/API/Push_API">Push API</a></li>
                        </ul>
                    </section>
                    <section>
                        <blockquote>
                            I got people with me, people who trust each other,
                            who do for each other and ain't always looking for
                            the advantage. There's good people in the 'verse.
                            Not many, lord knows, but you only need a few.
                            <cite>"Our Mrs. Reynolds." <em>Firefly</em>, performance by Nathan Fillion, season 1, episode 3, 2002-10-02.</cite>
                        </blockquote>

                    </section>
                </section>
                <section>
                    <section>
                        <h2>Details</h2>
                        <ul>
                            <li>Slides: <a href="https://stuff.coffeecode.net/2017/evergreen-progressive-web-app" property="url">stuff.coffeecode.net/2017/evergreen-progressive-web-app</a></li>
                            <li>Email: <span resource="#author"><a href="mailto:dscott@laurentian.ca" property="email">dscott@laurentian.ca</a></span></li>
                            <li>Social: <span resource="#author"><a href="https://twitter.com/denials" property="sameAs">@denials</a> / <a href="https://plus.google.com/+DanScottCAN" property="sameAs">+DanScottCAN</a></span></li>
                            <li>Blog: <span resource="#author"><a href="https://coffeecode.net" property="sameAs">coffeecode.net</a></span></li>
                        </ul>
                        <p class="smaller"><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" data-src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a></p>
                    </section>
                </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
