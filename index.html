<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>We aim to misbehave: Evergreen as a Progressive Web App</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">
<style>
.reveal h1,
.reveal h2,
.reveal h3,
.reveal h4,
.reveal h5,
.reveal h6 {
    text-transform: none;
}
.reveal img.inline-logo {
    border: none;
    vertical-align: middle;
    margin-right: 0.5em;
}
.reveal img.inline-logo.small {
    max-height: 2em;
    max-width: 2em;
}
.reveal .hidden {
    display:none;
}
.reveal .show {
    display:pre;
}
.reveal blockquote {
    text-align: left;
    width: 80%;
}
.reveal blockquote cite {
    font-size: 60%;
    float: right;
}
.reveal .demolinks {
    font-size: 80%;
}
li[onclick] {
    list-style-type: '† ';
}
</style>
<script>
function revealCode(showId, el, hideId) {
    let matches = document.querySelectorAll('.reveal .show');
    if (document.getElementById(showId).className == 'show') {
        document.getElementById(showId).className = 'hidden';
    }
    else {
        for (let match of matches) {
            match.className = 'hidden';
        }
        document.getElementById(showId).className = 'show';
    }
    if (el !== undefined && hideId !== undefined) {
        el.setAttribute('onclick', 'revealCode("' + hideId + '", this, "' + showId + '")');
    }
    Reveal.sync();
}
</script>
		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <section>
                    <section>
                        <h1>We aim to misbehave</h1>
                        <h2>Evergreen: Progressive Web App</h2>
                        <p>Dan Scott, Laurentian University</p>
                        <p>2017 Evergreen International Conference</p>
                        <p>2017-04-07</p>
                    </section>
                    <section>
                        <h2>Everyone wants an app</h2>
                        <ul>
                            <li>Offline access! Part of my device!</li>
                            <li class="fragment">But apps take time to develop:
                                <ul>
                                    <li>iOS vs. Android <span style="font-size: 60%">vs. Android <span style="font-size: 60%">vs. Android</span></span></li>
                                </ul>
                            </li>
                            <li class="fragment"><a href="https://www.recode.net/2016/9/16/12933780/average-app-downloads-per-month-comscore">Half of US users download 0 apps per month</a>
                                <ul>
                                    <li>Finding the right app can be hard</li>
                                    <li>App install banners can be annoying</li>
                                </ul>
                            </li>
                            <li class="fragment"><a href="http://info.localytics.com/blog/24-of-users-abandon-an-app-after-one-use">24% of people abandon an app after one use</a> (<em>Localytics</em>, 2017-03-30)</a>
                        </ul>
                    </section>
                    <section>
                        <h3>Let's improve the web app we have</h3>
                        <blockquote>
                            Y'all got on this boat for different reasons, but y'all come to the same place.
                            So now I'm asking more of you than I have before. Maybe all. Sure as I know
                            anything, I know this - they will try again. Maybe on another world, maybe on
                            this very ground swept clean. A year from now, ten? They'll swing back to the
                            belief that they can make [native apps]… better. And I do not hold to that. So no
                            more runnin'. I aim to misbehave.
                                <cite><em>Serenity</em>, performance by Nathan Fillion, 2005-09-30.</cite>
                        </blockquote>
                    </section>
                </section>
				<section>
                    <section>
                        <h2>Progressive Web Apps are... what?</h2>
                    </section>
                    <section>
                        <h3>From graceful degradation to progressive enhancement</h3>
                        <aside class="notes">
                            Where graceful degradation was a web design
                            philosophy arguing that web sites should still be
                            functional in the absence of JavaScript or advanced
                            HTML, the progressive enhancement philosophy takes
                            JavaScript as a baseline and argues that you should
                            enable your site to take advantage of functionality
                            offered by different web browsers, particularly those
                            on a standards track.
                        </aside>
                    </section>
                    <section>
                        <h3>Progressive Web Apps (PWAs)</h3>
                        <ul>
                            <li><a href="https://developers.google.com/web/progressive-web-apps/checklist">Baseline</a> - make web apps more like native apps:
                                <ul>
                                    <li><em>Responsive</em>: UI adapts to different devices</li>
                                    <li><em>Fast</em> to load and render</li>
                                    <li><em>Secure</em>: encrypted by HTTPS</li>
                                    <li><em>Reliable</em> under any network condition</li>
                                    <li><em>Installable</em> to your device home screen</li>
                                </ul>
                            </li>
                        </ul>
                        <aside class="notes">
                            All of these are worthwhile goals. Let's see what
                            happens when we try to adapt the Evergreen
                            catalogue to meet them.
                        </aside>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Auditing PWA progress</h3>
                            <ul>
                                <li><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> audits web apps for quality</li>
                                <li>Focused on PWA baseline criteria</li>
                                <li>Offers advice for <em>exemplary PWAs</em> as well</li>
                                <li>Chrome extension &amp; command line tool</li>
                            </ul>
                        </div>
                        <aside class="notes">
                            We would really benefit from an objective tool to
                            tell us how we're doing. Lighthouse is one such 
                            solution.
                        </aside>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Baseline: 37/100</h3>
                            <ul>
                                <li>Fresh Evergreen 2.12 install, without HTTPS</li>
                                <li>Praised for:
                                    <ul>
                                        <li>Page load performance is fast</li>
                                        <li>Site is progressively enhanced</li>
                                        <li>Design is mobile-friendly</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Baseline: 37/100</h3>
                            <ul>
                                <li>Fresh Evergreen 2.12 install, with HTTPS</li>
                                <li>Punished for:
                                    <ul>
                                        <li>Network connection is secure</li>
                                        <li>User can be prompted to Add to Homescreen</li>
                                        <li>Installed web app will launch with custom splash screen</li>
                                        <li>Address bar matches brand colors</li>
                                        <li>App can load on offline/flaky connections</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </section>
                    <section>
                        <h2>Let's encrypt that connection</h2>
                        <ul>
                            <li onclick="revealCode('tls-certbot')">Use <code>certbot</code> to get a free TLS certificate from <a href="https://letsencrypt.org">LetsEncrypt</a></li>
                            <li onclick="revealCode('tls-config')">Point the Apache config at the certificates</li>
                            <li onclick="revealCode('tls-everything')">Enable TLS for all connections</li>
                        </ul>
                        <pre id="tls-certbot" class="hidden"><code>certbot certonly --webroot -w /openils/var/web/ \
        -d shiny.example.org</code></pre>
                        <pre id="tls-config" class="hidden"><code>vim /etc/apache2/sites-enabled/eg.conf

SSLCertificateFile /etc/letsencrypt/live/shiny.example.org/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/shiny.example.org/privkey.pem</code></pre>
                        <pre id="tls-everything" class="hidden"><code>vim /etc/apache2/eg_vhost.conf

# Uncomment the following to force SSL for everything.
# Note that this defeats caching and you will suffer
# a performance hit.
RewriteCond %{HTTPS} off
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [NE,R,L]</code></pre>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>Baseline with HTTPS: 50/100</h3>
                            <blockquote class="fragment">
                                'Yes. Yes, this is a fertile land, and we will
                                thrive. We will rule over all this land, and we
                                will call it… "This Land."'
                                <cite>"Serenity." <em>Firefly</em>, performance by Alan Tudyk, season 1, episode 1, 2002-09-20. <em>Netflix</em>, https://www.netflix.com/watch/70133870?trackId=200257859.</cite>
                            </blockquote>
                        </div>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Manifest destiny</h2>
                        <blockquote>
                            The purpose of the manifest is to install web
                            applications to the homescreen of a device,
                            providing users with quicker access and a richer
                            experience.
                            <cite>"Web App Manifest." <em><a
                                    href="https://developer.mozilla.org/en-US/docs/Web/Manifest">Mozilla
                                    Developer Network</a></em></cite>
                        </blockquote>
                    </section>
                    <section>
                        <h3>Manifest basics</h3>
                        <ul>
                            <li>A JSON file with metadata about the web app</li>
                            <li>A link to the manifest from the <code>&lt;head&gt;</code></li>
                        </ul>

                        <pre><code>{
  "short_name": "Shiny!",
  "name": "Evergreen's Progressive Web App",
  "start_url": "/eg/opac/home"
}</code></pre>
                        <pre><code>&lt;link rel="manifest" href="/manifest.json" /&gt;</code></pre>
                        <aside class="notes">
                            <ul>
                                <li><code>short_name</code> will be displayed on your device, underneath the icon</li>
                                <li><code>name</code> is displayed while the application loads</li>
                                <li><code>start_url</code> is where the application will open when you launch it</li>
                            </ul>
                        </aside>
                    </section>
                    <section>
                        <h3>Manifest icons</h3>
                        <p>Multiple icons for multiple screen densities</p>
                        <pre><code>{
  "short_name": "Shiny!",
  "icons": [{
      "src": "/images/icon48.png", "type": "image/png",
      "sizes": "48x48"
    },
    {
      "src": "/images/icon96.png", "type": "image/png",
      "sizes": "96x96"
    },
    {
      "src": "/images/icon192.png", "type": "image/png",
      "sizes": "192x192"
    }],
}</code></pre>
                        <aside class="notes">
                            192x192 is the most critical size
                        </aside>
                    </section>
                    <section>
                        <h3>Manifest theming</h3>
                        <p>While the app launches, give it nice colours</p>
                        <pre><code>{
  "short_name": "Shiny!",
  "background_color": "#007a54",
  "theme_color": "#007a54",
}</code></pre>
                        <aside class="notes">
                            <ul>
                                <li><code>background_color</code> is for the splash screen</li>
                                <li><code>theme_color</code> can affect the operating system (title bar, etc)</li>
                            </ul>
                        </aside>
                    </section>
                    <section>
                        <h3><code>meta</code> theme-color</h3>
                        <p>The manifest theme color should have a matching <code>&lt;meta rel="theme-color" /&gt;</code> element</p>
                        <pre><code>&lt;meta rel="theme-color" value="#007a54" /&gt;</code></pre>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>HTTPS + manifest: 85/100</h3>
                            <blockquote class="fragment">
                                'Yes. Yes, this is a fertile land, and we will
                                thrive. We will rule over all this land, and we
                                will call it… "This Land."'
                                <cite>"Serenity." <em>Firefly</em>, performance by Alan Tudyk, season 1, episode 1, 2002-09-20. <em>Netflix</em>, https://www.netflix.com/watch/70133870?trackId=200257859.</cite>
                            </blockquote>
                        </div>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Optimizations</h2>
                        <ul>
                            <li><code>/eg/opac/home</code> first paint: 1648.1ms
                                <pre><code>…opac/home (shiny)
  …opac/semiauto.css (shiny) - 719.2ms, 14.61KB
  …opac/simple.js (shiny) - 796ms, 16.4KB
  …tundra/tundra.css (shiny) - 1,060.6ms, 54.93KB
  …css/style.css (shiny) - 1,175.7ms, 60.35KB
  …dojo/openils_dojo.js (shiny) - 1,456.5ms, 12.82KB
  …opensrf/JSON_v1.js (shiny) - 1,541.4ms, 15.97KB
  …opensrf/opensrf_xhr.js (shiny) - 1,571.1ms, 17.78KB
  …themes/dijit.css (shiny) - 1,640.9ms, 36.78KB
  …images/small_logo.png (shiny) - 1,747.4ms, 15.37KB
  …opensrf/opensrf.js (shiny) - 1,840.6ms, 39.31KB
  …images/eg_tiny_logo.png (shiny) - 1,926.7ms, 14.96KB
  …images/main_logo.png (shiny) - 1,941.4ms, 21.25KB
  …dojo/dojo.js (shiny) - 2,106ms, 92.59KB</code></pre>
                            </li>
                            <li><em>Dojo</em>? Didn't we try to avoid Dojo?</li>
                        </ul>
                    </section>
                    <section>
                        <h3><code>opac/parts/header.tt2</code></h3>
                        <pre><code># Dojo is required to use the copy locations advanced search
# filter, therefore, it should always be enabled.
want_dojo = 1;

IF use_autosuggest.enabled == "t";
    want_dojo = 1;
END;

IF ctx.google_books_preview;
    want_dojo = 1;
END;

IF ENV.OILS_NOVELIST_URL;
    want_dojo = 1;
END;
</code></pre>
                    </section>
                    <section>
                        <h3>The fix is in <a href="https://bugs.launchpad.net/evergreen/+bug/1411699">bug 1411699</a></h3>
                        <pre><code>…opac/home (shiny)
  …opac/semiauto.css (shiny) - 592ms, 11.48KB
  …opac/simple.js (shiny) - 642.3ms, 13.26KB
  …css/style.css (shiny) - 862.8ms, 58.53KB
  …images/eg_tiny_logo.png (shiny) - 1,041.5ms, 11.82KB
  …images/main_logo.png (shiny) - 1,071.5ms, 18.12KB</code></pre>
                        <ul>
                            <li class="fragment">Still 85/100 , but first paint is down to 1011.9ms!</li>
                            <li class="fragment">Most of the points are docked because we fail the <em>App can load on offline/flaky connections</em> test</li>
                        </ul>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Handling offline/flaky connections:</h2>
                        <h3>Introducing service workers</h3>
                    </section>
                    <section>
                        <h3>Service workers</h3>
                        <ul>
                            <li>A separate JavaScript per origin <em>scope</em></li>
                            <li>Runs on a separate thread</li>
                            <li>No access to the DOM</li>
                            <li>Can intercept and modify network requests for fine-grained <a href="https://serviceworke.rs/">caching strategies</a></li>
                            <li>Enables push notifications, too!</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Service worker support</h3>
                        <ul>
                            <li><a href="https://jakearchibald.github.io/isserviceworkerready/">Supported by</a> Chrome, Firefox, Opera</li>
                            <li>Microsoft Edge is working on it</li>
                            <li>Safari… 🤷</li>
                            <li class="fragment">But progressive enhancement means it's okay!</li>
                        </ul>
                    </section>
                    <section>
                        <h3>Service worker registration</h3>
                        <pre><code>&lt;script&gt;
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // Your service worker *must* be located at
    // the top-level directory relative to your site.
    // It won't be able to control pages unless it's
    // located at the same level or higher than them.
    navigator.serviceWorker.register('/sw.js')
      .then(function(reg) { /* … stuff! */ })
      .catch(function(e) { console.error('Error:', e); });
  }
}
&lt;/script&gt;</code></pre>
                        <cite>Adapted from <a href="https://github.com/GoogleChrome/sw-precache/blob/master/demo/app/js/service-worker-registration.js">Google SW registration boilerplate</a></cite>
                    </section>
                    <section>
                        <h3>Service worker: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a></h3>
                        <ul>
                            <li>More flexible than <code>XMLHttpRequest()</code>
                                <ul>
                                    <li>Generic <a href="https://developer.mozilla.org/en-US/docs/Web/API/Request">Request</a>, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">Response</a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/API/Headers">Headers</a> interfaces</li>
                                </ul>
                            </li>
                            <li><a href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent">FetchEvent</a> handler + <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">fetch()</a> + <a href="https://developer.mozilla.org/en-US/docs/Web/API/Cache">Cache API</a> + cache dedicated to a given web app:
                                <ul>
                                    <li>Fetch network requests from the cache</li>
                                    <li>Store network responses in the cache</li>
                                    <li class="fragment">Overcome network flakiness!</li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>Let there be patterns!</h3>
                        <p><a href="https://serviceworke.rs/">serviceworke.rs</a> offers examples of caching strategies</p>
                    </section>
                    <section>
                        <h3><a href="https://serviceworke.rs/strategy-network-or-cache.html">Network-or-cache</a></h3>
                        <pre><code>self.addEventListener('fetch', function(evt) {
  if evt.respondWith(fromNetwork(evt.request, 400)
  .catch(function () {
    return fromCache(evt.request);
  }));
});
function fromNetwork(request, timeout) {
  return new Promise(function (fulfill, reject) {
  var timeoutId = setTimeout(reject, timeout);
  fetch(request).then(function (response) {
      clearTimeout(timeoutId);
      fulfill(response);
    }, reject);
  });
}</code></pre>
                    </section>
                    <section>
                        <h3><a href="https://serviceworke.rs/strategy-cache-and-update.html">Cache and update</a></h3>
                        <pre><code>self.addEventListener('fetch', function(evt) {
  evt.respondWith(fromCache(evt.request));
  evt.waitUntil(update(evt.request));
});
function fromCache(request) {
  return caches.open(CACHE).then(function (cache) {
    return cache.match(request).then(function (matching) {
      return matching || Promise.reject('no-match');
    });
  });
}
function update(request) {
  return caches.open(CACHE).then(function (cache) {
    return fetch(request).then(function (response) {
      return cache.put(request, response);
    });
  });
}</code></pre>
                    </section>
                    <section>
                        <h3>Let there be tools!</h3>
                        <ul>
                            <li>We could roll our own service worker based on the <a href="https://serviceworke.rs/">serviceworke.rs</a> patterns</li>
                            <li>But libraries provide a nice layer of abstraction:
                                <ul>
                                    <li><a href="https://github.com/GoogleChrome/sw-toolbox">sw-toolbox</a> implements network handlers with five request/caching patterns</li>
                                    <li><a href="https://github.com/GoogleChrome/sw-precache">sw-precache</a> builds on <code>sw-toolbox</code> to generate a service worker based on a configuration file</li>
                                </ul>
                            </li>
                        </ul>
                    </section>
                    <section>
                        <h3>package.json</h3>
<pre><code>{
  "name": "evergreen-pwa-stuff",
  "version": "1.0.0",
  "description": "Evergreen PWA stuff",
  "author": "Dan Scott",
  "license": "GPL-2.0+",
  "dependencies": {
    "sw-precache": "&gt;4.3.0"
  }
}</code></pre>
<pre><code>$ npm install</code></pre>
                    </section>
                    <section>
                        <h3>sw-precache basic dumb config</h3>
                        <pre><code>module.exports = {
  staticFileGlobs: [
    '/openils/var/web/css/skin/default/opac/semiauto.css',
    '/openils/var/web/js/ui/default/opac/simple.js',
    '/openils/var/web/opac/images/small_logo.png',
    '/openils/var/web/opac/images/progressbar_green.png',
    '/openils/var/web/opac/images/main_logo.png',
    '/openils/var/web/opac/images/eg_tiny_logo.png'
  ],
  stripPrefix: '/openils/var/web/',
  runtimeCaching: [{
    urlPattern: /^https:\/\/shiny.example.org\//,
    handler: 'networkFirst'
  }]
};</code></pre>
                    </section>
                    <section>
                        <h3>Enable our service worker</h3>
                        <ol>
                            <li onclick="revealCode('sw-generate')">Generate and install the service worker</li>
                            <li onclick="revealCode('sw-copy')">Copy boilerplate registration code into place</li>
                            <li onclick="revealCode('sw-register')">Add registration to <code style="font-size: smaller;white-space:nowrap;">templates/opac/parts/base.tt2</code></li>
                        </ol>
<pre id="sw-generate" class="hidden"><code data-noescape data-trim class="lang-bash">
$ <strong>node_modules/sw-precache/cli.js --config sw-precache.js</strong>
Total precache size is about 18.2 kB for 6 resources.
service-worker.js has been generated.
$ <strong>cp service-worker.js /openils/var/web/sw.js</strong>
</code></pre>
<pre id="sw-copy" class="hidden"><code data-noescape data-trim class="lang-bash">
$ <strong>cp sw-register.js /openils/var/web/.</strong>
</code></pre>
<pre id="sw-register" class="hidden"><code data-trim class="lang-bash">
<script src="/js/sw-register.js" async></script>
</code></pre>
                    </section>
                    <section data-background="images/lighthouse.png">
                        <div style="background:rgba(0,0,0,0.9);">
                            <h3>HTTPS + manifest + service worker: 100/100</h3>
                            <p class="fragment">Shut. Up.</p>
                        </div>
                    </section>
                </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
